/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.6.1/userguide/tutorial_java_projects.html
 */

buildscript {
    repositories {
        maven {
            url 'https://oss.sonatype.org/content/groups/public/'
        }
    }
}

plugins {
    // Apply the java plugin to add support for Java
    id 'java'

    // Apply the application plugin to add support for building a CLI application.
    id 'application'
    id 'eclipse'

    id 'io.bdeploy.gradle.plugin'

    id "com.github.ben-manes.versions" version "0.52.0"
}

repositories {
    mavenCentral()
}

version = "1.0.2-SNAPSHOT"

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

ext {
    buildDate = new Date().format('yyyyMMddHHmmss')
    buildVersion = project.version.replaceAll('SNAPSHOT', buildDate)
}

dependencies {
    // This dependency is used by the application.
    implementation 'com.google.guava:guava:33.4.8-jre'

    testImplementation platform('org.junit:junit-bom:5.13.2')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

application {
    // Define the main class for the application.
    mainClassName = 'io.bdeploy.gradle.test.App'
}

test {
    // Use junit platform for unit tests
    useJUnitPlatform()
}

task validateProduct(type: io.bdeploy.gradle.BDeployValidationTask, dependsOn: installDist) {
    // don't use 'token' so we don't need to configure instanceGroup (etc.) when just testing validation.
    if(project.hasProperty('vtoken')) {
        validationServer {
            uri = 'https://localhost:7701/api'
            token = project.getProperty('vtoken')
        }
    } else {
        validationServer {
            useLogin = true
        }
    }

    validationYaml = file('bdeploy/product-validation.yaml')
}

task buildProduct(type: io.bdeploy.gradle.BDeployProductTask, dependsOn: installDist) {
    if(project.hasProperty('token')) {
        repositoryServer {
            uri = 'https://localhost:7701/api'
            token = project.getProperty('token')
        }
    } else {
        repositoryServer {
            useLogin = true
            loginStorage = "${buildDir}"
        }
    }
    product {
        version = project.ext.buildVersion
        productInfo = file('bdeploy/product-info.yaml')

        applications {
            test {
                yaml = new File(installDist.destinationDir, 'app-info.yaml')
            }
        }

        labels.put('buildDate', project.ext.buildDate)
    }
}

task zipProduct(type: io.bdeploy.gradle.BDeployZipTask, dependsOn: buildProduct) {
    of buildProduct
    output = new File(buildDir, "product-" + project.ext.buildVersion + ".zip");
}


task pushProduct(type: io.bdeploy.gradle.BDeployPushTask, dependsOn: buildProduct) {
    of buildProduct

    target.servers {
        if(project.hasProperty('token')) {
            localhost {
                uri = 'https://localhost:7701/api'
                token = project.getProperty('token')
                instanceGroup = project.getProperty('instanceGroup')
            }
        }
        if(project.hasProperty('centralToken')) {
            central {
                uri = 'https://localhost:7705/api'
                token = project.getProperty('centralToken')
                instanceGroup = project.getProperty('centralInstanceGroup')
            }
        }
        if(project.hasProperty('pushLocal')) {
            localWithLogin {
                useLogin = true
                instanceGroup = project.getProperty('pushLocal')
            }
        }
    }
}

